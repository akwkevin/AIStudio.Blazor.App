@page "/Quartz_Manage/Quartz_Task/List"

@inherits BaseListWithEdit<Quartz_TaskDTO, EditForm>

<Space Size="@("small")">

    @if (Operator.HasPerm("Quartz_Task.Add"))
    {
        <SpaceItem>
            <Button Type="@ButtonType.Primary" Icon="plus" OnClick="()=>Edit(null)">新建</Button>
        </SpaceItem>
    }
    @if (Operator.HasPerm("Quartz_Task.Edit"))
    {
        <SpaceItem>
            <Button Type="@ButtonType.Primary" Icon="plus" OnClick="()=>Pause()" disabled=@NoneSelectedItems>暂停</Button>
        </SpaceItem>
        <SpaceItem>
            <Button Type="@ButtonType.Primary" Icon="plus" OnClick="()=>Start()" disabled=@NoneSelectedItems>开启</Button>
        </SpaceItem>   <SpaceItem>
            <Button Type="@ButtonType.Primary" Icon="plus" OnClick="()=> ToDo()" disabled=@NoneSelectedItems>立即执行</Button>
        </SpaceItem>
    }
    @if (Operator.HasPerm("Quartz_Task.Delete"))
    {
        <SpaceItem>
            <Popconfirm Title="确认删除选中项吗?"
                    OnConfirm="()=>Delete()"
                    OnCancel="()=>{}"
                    OkText="确定"
                    CancelText="取消"
                    disabled=@NoneSelectedItems>
                <Button Type="@ButtonType.Primary" Danger Icon="minus" disabled=@NoneSelectedItems>删除</Button>
            </Popconfirm>
        </SpaceItem>
    }
    <SpaceItem>
        <Search Placeholder="关键字" EnterButton="true" @bind-Value="@Keyword" disabled=@Loading OnSearch="()=>Refresh()" />
    </SpaceItem>
</Space>

<Table @ref="_table" TItem="Quartz_TaskDTO" DataSource="Data" Loading="Loading" @bind-PageSize="Pagination.PageRows" @bind-SelectedRows="SelectedItems">
    <ChildContent>
        <Selection Key="@(context.Id)" />
        <AntDesign.Column Title="作业名称" DataIndex="TaskName" TData="string" />
        <AntDesign.Column Title="分组" DataIndex="GroupName" TData="string" />
        <AntDesign.Column Title="最后执行时间" DataIndex="LastRunTime" TData="DateTime" />
        <AntDesign.Column Title="间隔(Cron)" DataIndex="Interval" TData="string" />
        <AntDesign.Column Title="状态" TData="int">
            @if (context.Status == 0)
            {
                <Badge Status="processing" Text="运行中" />
            }
            else if (context.Status == 1)
            {
                <Badge Status="default" Text="关闭" />
            }
            else if (context.Status == 2)
            {
                <Badge Status="success" Text="完成" />
            }
            else if (context.Status == 3)
            {
                <Badge Status="error" Text="异常" />
            }
            else if (context.Status == 4)
            {
                <Badge Status="error" Text="堵塞" />
            }
            else if (context.Status == 5)
            {
                <Badge Status="default" Text="未知" />
            }
        </AntDesign.Column>
        <AntDesign.Column Title="描述" DataIndex="Describe" TData="string" />
        <AntDesign.Column Title="ApiUrl" DataIndex="ApiUrl" TData="string" />
        <AntDesign.Column Title="请求方式" DataIndex="RequestType" TData="string" />
        <ActionColumn Title="Action">
            <Space Size=@("small")>
                <SpaceItem>
                    <Button Type="@ButtonType.Link" OnClick="()=>Edit(context)">Edit</Button>
                    <Popconfirm Title="确认删除吗?"
                                OnConfirm="()=>Delete(context.Id)"
                                OnCancel="()=>{}"
                                OkText="确定"
                                CancelText="取消">
                        <Button Danger Type="@ButtonType.Link">Delete</Button>
                    </Popconfirm>
                    <Button Type="@ButtonType.Link" OnClick="()=>Log(context)">Log</Button>
                </SpaceItem>
            </Space>
        </ActionColumn>
    </ChildContent>
    <PaginationTemplate>
        <div style="float:right;margin-top:10px">
            <Pagination Total="Pagination.Total"
                        ShowTotal="ShowTotal"
                        ShowSizeChanger
                        PageSize="Pagination.PageRows"
                        Current="Pagination.PageIndex"
                        OnChange="PageIndexChanged"
                        OnShowSizeChange="PageSizeChanged" />
        </div>
    </PaginationTemplate>
</Table>


@code
{
    public List()
    {
        Area = "Quartz_Manage";
    }

    private async void Log(Quartz_TaskDTO para)
    {
        var modalConfig = new ModalOptions();
        modalConfig.Title = "编辑表单";
        //modalConfig.Style = "top:20px;";
        // In order for Dispose in ConfirmTemplateDemo to take effect every time it is closed
        //modalConfig.BodyStyle += "overflow-y: auto;";
        modalConfig.DestroyOnClose = true;
        modalConfig.Centered = true;

        var modalRef = await ModalService.CreateModalAsync<LogForm, string>(modalConfig, para.GroupName + "." + para.TaskName);

    }

    private void Pause()
    {
        Excute("暂停", "PauseData");
    }

    private void Start()
    {
        Excute("开始", "StartData");      
    }

    private void ToDo()
    {
        Excute("立即执行", "ToDoData");      
    }

    private void Excute(string Text, string Action)
    {
        List<string> ids = SelectedItems.Select(p => p.Id).ToList();
        Func<ModalClosingEventArgs, Task> onOkClick = async (e) =>
        {
            try
            {
                ShowWait();

                var result = await DataProvider.GetData<AjaxResult>($"/Quartz_Manage/Quartz_Task/{Action}", ids.ToJson());
                if (!result.Success)
                {
                    throw new MsgException(result.Msg);
                }
                await GetData();
            }
            catch (Exception ex)
            {
                await Error.ProcessError(ex);
            }
            finally
            {
                HideWait();
            }
        };

        RenderFragment icon = (builder) =>
        {
            var index = 0;
            IEnumerable<KeyValuePair<string, object>> paramenter = new List<KeyValuePair<string, object>>()
            {
                new KeyValuePair<string, object>("Type","check-circle")
            };

            builder.OpenComponent(index++, typeof(Icon));
            builder.AddMultipleAttributes(index++, paramenter);
            builder.CloseComponent();

        };
        ModalService.Confirm(new ConfirmOptions()
        {
            Title = $"任务{Text}",
            Icon = icon,
            Content = $"确认{Text}吗？",
            Centered = true,
            OnOk = onOkClick
        });
    }


}